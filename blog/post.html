!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carregando post... - Blog Unisulistas</title>
    <link rel="stylesheet" href="../style.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <header>
        <div class="header-visual-background"></div>
        <div class="header-content-container">
            <div class="container">
                <!-- Caminho ajustado para pasta interna -->
                <img id="logo" src="../Logos EDGETI/LOGO FUNDO TRANSPARENTE.png" alt="Logo Unisulistas">
                
                <nav class="main-nav">
                    <ul>
                        <li><a href="/#home">Início</a></li>
                        <li class="nav-item-dropdown">
                            <a href="/#services">Cursos <i class="fas fa-chevron-down"></i></a>
                            <ul class="dropdown-menu">
                                <li><a href="/index.html#detalhe-informatica">Informática</a></li>
                                <li><a href="/index.html#detalhe-redes">Redes</a></li>
                                <li><a href="/index.html#detalhe-seguranca">Segurança</a></li>
                                <li><a href="/index.html#detalhe-cloud">Nuvem</a></li>
                            </ul>
                        </li>
                        <li><a href="/blog/">Blog</a></li>
                        <li><a href="/#contact">Contato</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <section class="post-section">
            <div class="container post-layout">
                <div class="post-main-content">
                    <div id="post-content-area">
                        <p style="color: white; text-align: center; margin-top: 50px;">
                            <i class="fas fa-spinner fa-spin"></i> A carregar conteúdo do post...
                        </p>
                        <p id="debug-msg" style="color: #aaa; text-align: center; font-size: 0.8rem;"></p>
                    </div>
                </div>

                <!-- Barra Lateral -->
                <aside class="post-sidebar">
                    <div class="sidebar-widget">
                        <h3>Fale Conosco</h3>
                        <p>Dúvidas sobre o curso? Entre em contato.</p>
                        <a href="#" class="cta-button whatsapp-button">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </a>
                    </div>
                </aside>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 Unisulistas. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
        // ===========================================================
        // CONFIGURAÇÃO (ATUALIZE O LINK SE O NGROK REINICIOU)
        // ===========================================================
        const BACKEND_URL = 'https://tomasa-pyrogallic-tiesha.ngrok-free.dev';
        // ===========================================================

        const postArea = document.getElementById('post-content-area');
        const debugMsg = document.getElementById('debug-msg');
        const params = new URLSearchParams(window.location.search);
        const postSlug = params.get('slug');

        function showDebug(msg) {
            console.log(msg);
            if(debugMsg) debugMsg.innerText = msg;
        }

        // Função segura para converter blocos de texto
        function convertContentToHtml(contentBlocks) {
            if (!Array.isArray(contentBlocks)) return '<p>Sem conteúdo.</p>';
            
            let html = '';
            contentBlocks.forEach(block => {
                // Proteção contra blocos vazios
                if (!block.children) return;

                const text = block.children.map(c => c.text || '').join('');
                
                if (block.type === 'paragraph') {
                    // Só adiciona se tiver texto
                    if(text.trim()) html += `<p>${text}</p>`;
                } else if (block.type === 'heading') {
                    const level = block.level || 2;
                    html += `<h${level}>${text}</h${level}>`;
                } else if (block.type === 'list') {
                    const listType = block.format === 'ordered' ? 'ol' : 'ul';
                    const listItems = block.children.map(item => {
                        const itemText = item.children ? item.children.map(c => c.text).join('') : '';
                        return `<li>${itemText}</li>`;
                    }).join('');
                    html += `<${listType}>${listItems}</${listType}>`;
                }
            });
            return html;
        }

        // Validação inicial
        if (!postSlug) {
            postArea.innerHTML = '<h1 style="color: white; text-align: center;">Link inválido (falta o slug).</h1>';
            throw new Error("Slug não encontrado na URL");
        }

        const apiUrl = `${BACKEND_URL}/api/posts?filters[slug][$eq]=${postSlug}&populate=*`;
        showDebug("A conectar ao servidor...");

        // Fetch Simples
        fetch(apiUrl)
        .then(res => {
            if(!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
            return res.json();
        })
        .then(data => {
            showDebug("Dados recebidos. A processar...");

            if (!data.data || data.data.length === 0) {
                postArea.innerHTML = '<h1 style="color: white; text-align: center;">Post não encontrado no sistema.</h1>';
                return;
            }

            // Padrão Strapi v5
            const post = data.data[0]; 
            
            document.title = (post.seo_title || post.title) + " - Blog";
            
            // Lógica da Imagem
            let imgHTML = '';
            const relativePath = post.cover_image?.url;
            if (relativePath) {
                imgHTML = `<img class="post-main-image" src="${BACKEND_URL}${relativePath}" alt="${post.title}">`;
            }
            
            // Conversão do Texto
            const contentHtml = convertContentToHtml(post.content);

            // Renderização Final
            postArea.innerHTML = `
                <h1>${post.title}</h1>
                ${imgHTML}
                <div class="post-body">
                    ${contentHtml}
                </div>
            `;
        })
        .catch(error => {
            console.error('Erro grave:', error);
            postArea.innerHTML = `
                <div style="text-align: center; color: #ff6b6b;">
                    <h1>Ops! Ocorreu um erro.</h1>
                    <p>Detalhes: ${error.message}</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">
                        Dica: Verifique se o Ngrok está rodando e se você clicou em "Visit Site".
                    </p>
                </div>
            `;
        });
    </script>
</body>
</html>